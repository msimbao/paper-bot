<!DOCTYPE html>
<html>
<head>
    <title>Backtest Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #0f0f23; 
            color: #fff;
            font-family: Arial, sans-serif;
        }
        #container { 
            max-width: 1600px; 
            margin: 0 auto; 
        }
        .chart-container {
            position: relative;
            margin-bottom: 30px;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
        }
        .chart-wrapper-price {
            position: relative;
            height: 500px;
            width: 100%;
        }
        .chart-wrapper-rsi {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .stats {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        .positive { color: #66bb6a; }
        .negative { color: #ef5350; }
        #loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Backtest Results</h1>
        <div id="loading">Loading data...</div>
        <div id="content" style="display: none;">
            <div class="stats" id="stats"></div>
            
            <div class="chart-container">
                <h3>Price & EMA</h3>
                <div class="chart-wrapper-price">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>RSI Indicator</h3>
                <div class="chart-wrapper-rsi">
                    <canvas id="rsiChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        fetch('backtest_results.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Display stats
                const stats = document.getElementById('stats');
                stats.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-label">Final Balance</div>
                        <div class="stat-value">$${data.results.finalBalance.toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value ${data.results.roi >= 0 ? 'positive' : 'negative'}">
                            ${data.results.roi.toFixed(2)}%
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value">${data.results.winRate.toFixed(1)}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value">${data.results.wins + data.results.losses}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Wins</div>
                        <div class="stat-value positive">${data.results.wins}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Losses</div>
                        <div class="stat-value negative">${data.results.losses}</div>
                    </div>
                `;

                const times = data.candles.map(c => new Date(c.time));
                
                // Create annotations for trades
                const annotations = {};
                
                data.trades.forEach((trade, idx) => {
                    const color = trade.type === 'BUY' ? 'rgba(76, 175, 80, 0.8)' : 'rgba(244, 67, 54, 0.8)';
                    
                    annotations[`trade${idx}`] = {
                        type: 'point',
                        xValue: new Date(trade.time),
                        yValue: trade.price,
                        backgroundColor: color,
                        radius: 8,
                        borderWidth: 2,
                        borderColor: '#fff'
                    };
                });

                // Add trailing stop events
                data.trailingStopEvents.forEach((event, idx) => {
                    annotations[`trail${idx}`] = {
                        type: 'point',
                        xValue: new Date(event.time),
                        yValue: event.stopPrice,
                        backgroundColor: 'rgba(255, 193, 7, 0.6)',
                        radius: 5,
                        borderWidth: 1,
                        borderColor: '#fff'
                    };
                });

                // Price Chart
                const priceCtx = document.getElementById('priceChart').getContext('2d');
                new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [
                            {
                                label: 'Price',
                                data: data.prices,
                                borderColor: '#4fc3f7',
                                backgroundColor: 'rgba(79, 195, 247, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true
                            },
                            {
                                label: `EMA(${data.config.emaPeriod})`,
                                data: data.emas,
                                borderColor: '#ff6b9d',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            }
                        ]
                    },
                   options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        mode: 'index',
        intersect: false
    },
    scales: {
        x: {
            type: 'time',
            time: {
                unit: 'auto',  // Changed from 'hour'
                displayFormats: {
                    hour: 'MMM d, HH:mm',
                    day: 'MMM d',
                    minute: 'HH:mm'
                }
            },
            grid: {
                color: '#2a2a4e'
            },
            ticks: {
                color: '#888',
                maxRotation: 45,
                minRotation: 45
            }
        },
        y: {
            grid: {
                color: '#2a2a4e'
            },
            ticks: {
                color: '#888'
            }
        }
    },
    plugins: {
        legend: {
            labels: {
                color: '#e0e0e0'
            }
        },
        annotation: {
            annotations: annotations
        }
    }
}
                }
            );

                // RSI Chart
                const rsiCtx = document.getElementById('rsiChart').getContext('2d');
                new Chart(rsiCtx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: `RSI(${data.config.rsiPeriod})`,
                            data: data.rsis,
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour'
                                },
                                grid: {
                                    color: '#2a2a4e'
                                },
                                ticks: {
                                    color: '#888'
                                }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: {
                                    color: '#2a2a4e'
                                },
                                ticks: {
                                    color: '#888'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            },
                            annotation: {
                                annotations: {
                                    oversold: {
                                        type: 'line',
                                        yMin: 30,
                                        yMax: 30,
                                        borderColor: 'rgba(76, 175, 80, 0.5)',
                                        borderWidth: 1,
                                        borderDash: [5, 5]
                                    },
                                    overbought: {
                                        type: 'line',
                                        yMin: 70,
                                        yMax: 70,
                                        borderColor: 'rgba(244, 67, 54, 0.5)',
                                        borderWidth: 1,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = 
                    `<div style="color: #ef5350;">
                        Error loading data: ${err.message}<br><br>
                        Make sure you're running this through a local server (not file://).<br>
                        Run: <code>npx http-server</code> then open http://localhost:8080/generate_chart.html
                    </div>`;
            });
    </script>
</body>
</html>